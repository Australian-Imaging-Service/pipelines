title: "Functional MRI data preprocessing pipeline"
schema_version: 2.0
version: &package_version "23.1.4"
base_image:
  name: nipreps/fmriprep
  tag: *package_version
  package_manager: apt
packages:
  pip:
    - pydra-tasks-dcm2niix
    - pydra-tasks-mrtrix3
    - pydra-compose-bidsapp
  neurodocker:
    dcm2niix: v1.0.20250506
    mrtrix3: "3.0.4"
licenses:
  freesurfer:
    destination: /opt/freesurfer/license.txt
    info_url: https://surfer.nmr.mgh.harvard.edu/registration.html
    description: >
      `fMRIPRep` uses FreeSurfer tools, which require a license to run.
authors:
  - name: Thomas G. Close
    email: thomas.close@sydney.edu.au
docs:
  info_url: https://fmriprep.org
  description: |
    `fMRIPrep` is a functional magnetic resonance imaging (fMRI) data preprocessing
    pipeline that is designed to provide an easily accessible, state-of-the-art
    interface that is robust to variations in scan acquisition protocols and that
    requires minimal user input, while providing easily interpretable and comprehensive
    error and output reporting. It performs basic processing steps (coregistration,
    normalization, unwarping, noise component extraction, segmentation,
    skullstripping etc.) providing outputs that can be easily submitted to a variety
    of group level analyses, including task-based or resting-state fMRI, graph
    theory measures, surface or volume-based statistics, etc.

    Optional flags that can be provided to the `fmriprep_flags` parameter:
    ```
      [--anat-only] [--boilerplate_only] [--md-only-boilerplate]
      [--error-on-aroma-warnings] [-v]
      [--ignore {fieldmaps,slicetiming,sbref,t2w,flair} [{fieldmaps,slicetiming,sbref,t2w,flair} ...]]
      [--output-spaces [OUTPUT_SPACES [OUTPUT_SPACES ...]]]
      [--me-output-echos] [--bold2t1w-init {register,header}]
      [--bold2t1w-dof {6,9,12}] [--force-bbr] [--force-no-bbr]
      [--medial-surface-nan] [--slice-time-ref SLICE_TIME_REF]
      [--random-seed _RANDOM_SEED]
      [--use-aroma]
      [--aroma-melodic-dimensionality AROMA_MELODIC_DIM]
      [--return-all-components]
      [--fd-spike-threshold REGRESSORS_FD_TH]
      [--dvars-spike-threshold REGRESSORS_DVARS_TH]
      [--skull-strip-template SKULL_STRIP_TEMPLATE]
      [--skull-strip-fixed-seed]
      [--skull-strip-t1w {auto,skip,force}] [--fmap-bspline]
      [--fmap-no-demean] [--topup-max-vols TOPUP_MAX_VOLS]
      [--use-syn-sdc [{warn,error}]] [--force-syn]
      [--no-submm-recon] [--cifti-output [{91k,170k}] | --fs-no-reconall]
      [--resource-monitor]
      [--reports-only] [--config-file FILE] [--write-graph]
      [--stop-on-first-crash] [--notrack]
      [--debug {compcor,fieldmaps,all} [{compcor,fieldmaps,all} ...]]
      [--sloppy]
    ```
  known_issues:
    - description: See App issues page
      url: https://github.com/nipreps/fmriprep/issues
commands:
  fmriprep:
    task:
      type: bidsapp
      app: /opt/conda/bin/fmriprep
      inputs:
        t1w:
          type: medimage/nifti-gz-x
          help: "T1-weighted anatomical scan"
          path: anat/T1w
        t2w:
          type: medimage/nifti-gz-x
          help: "T2-weighted anatomical scan"
          path: anat/T2w
        bold:
          type: medimage/nifti-gz-x
          help: "functional MRI"
          path: func/task-rest_bold
        fmap_magnitude1:
          type: medimage/nifti-gz-x
          help: "Field map - BIDS Case 1 & 2: magnitude of first echo"
          path: fmap/magnitude1
        fmap_magnitude2:
          type: medimage/nifti-gz-x
          help: "Field map - BIDS Case 1 & 2: magnitude of second echo"
          path: fmap/magnitude2
        fmap_magnitude:
          type: medimage/nifti-gz-x
          help: "Field map - BIDS Case 3: magnitude image used for anatomical reference"
          path: fmap/magnitude
        fmap_phasediff:
          type: medimage/nifti-gz-x
          help: "Field map - BIDS Case 1: phasediff image corresponding to the phase-diff map between echo times"
          path: fmap/phasediff
        fmap_phase1:
          type: medimage/nifti-gz-x
          help: "Field map - BIDS Case 2: phase of first echo"
          path: fmap/phase1
        fmap_phase2:
          type: medimage/nifti-gz-x
          help: "Field map - BIDS Case 2: phase of second echo"
          path: fmap/phase2
        fmap_fieldmap:
          type: medimage/nifti-gz-x
          help: "Field map - BIDS Case 3: directly reconstructed field map"
          path: fmap/fieldmap
        fmap_epi:
          type: medimage/nifti-gz-x
          path: fmap/epi
          help: >-
            Field map - BIDS Case 4: Spin Echo EPI scans with different phase encoding
            directions to estimate the distortion map corresponding to the nonuniformities
            of the B0 field
      outputs:
        fmriprep:
          type: generic/directory
          help: Preprocessed fMRI data
          path: fmriprep
    parameters:
      - flags
    operates_on: medimage/session
    configuration:
      work_dir: /work/nipype-work
      json_edits:
        path: "fmap/.*"
        jq_expr: '.IntendedFor = "{bold}"'
